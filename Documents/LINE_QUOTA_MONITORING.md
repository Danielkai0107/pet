# LINE è¨Šæ¯é…é¡ç›£æ§ç³»çµ±

## åŠŸèƒ½æ¦‚è¿°

æ•´åˆ LINE Messaging API å®˜æ–¹é…é¡æŸ¥è©¢åŠŸèƒ½ï¼Œè®“åº—å®¶å³æ™‚äº†è§£æ¯æœˆå…è²»è¨Šæ¯çš„ä½¿ç”¨ç‹€æ³ã€å‰©é¤˜é¡åº¦ï¼Œä¸¦åœ¨æ¥è¿‘ä¸Šé™æ™‚æä¾›è­¦å‘Šã€‚

---

## å¯¦ä½œå…§å®¹

### 1. Backend - Cloud Function

**æª”æ¡ˆ**: `functions/src/index.ts`

**æ–°å¢å‡½æ•¸**: `getLineOfficialQuota`

**åŠŸèƒ½**:

- å¾ Firestore å–å¾—åº—å®¶çš„ LINE Channel Access Token
- ä¸¦è¡Œèª¿ç”¨ LINE API çš„å…©å€‹ç«¯é»ï¼š
  - `GET /v2/bot/message/quota` - å–å¾—æ¯æœˆé…é¡ä¸Šé™
  - `GET /v2/bot/message/quota/consumption` - å–å¾—æœ¬æœˆå·²ä½¿ç”¨æ•¸é‡
- è¨ˆç®—å‰©é¤˜é…é¡å’Œä½¿ç”¨ç‡ç™¾åˆ†æ¯”
- å›å‚³å®Œæ•´çš„é…é¡è³‡è¨Š

**API ç«¯é»**:

```
GET /getLineOfficialQuota?shopId={shopId}
```

**å›æ‡‰æ ¼å¼**:

```json
{
  "success": true,
  "data": {
    "quota": 500,
    "used": 247,
    "remaining": 253,
    "percentage": 49.4,
    "type": "limited"
  }
}
```

---

### 2. Frontend - Hook æ“´å……

**æª”æ¡ˆ**: `src/hooks/useLineMessageQuota.ts`

**æ–°å¢æ¬„ä½**:

```typescript
interface LineQuotaData {
  officialQuota: {
    total: number; // æ¯æœˆç¸½é…é¡ï¼ˆä¾‹å¦‚ï¼š500ï¼‰
    used: number; // å®˜æ–¹çµ±è¨ˆçš„å·²ä½¿ç”¨æ•¸é‡
    remaining: number; // å‰©é¤˜å¯ç”¨æ•¸é‡
    percentage: number; // ä½¿ç”¨ç‡ç™¾åˆ†æ¯”
    type: string; // "limited" or "none"
  } | null;
  // ... æ—¢æœ‰æ¬„ä½ä¿ç•™
}
```

**ç‰¹æ€§**:

- ä¸¦è¡ŒæŸ¥è©¢å®˜æ–¹é…é¡å’Œç³»çµ±çµ±è¨ˆ
- é™ç´šæ–¹æ¡ˆï¼šå¦‚æœå®˜æ–¹é…é¡æŸ¥è©¢å¤±æ•—ï¼Œä»é¡¯ç¤ºç³»çµ±çµ±è¨ˆ
- é–‹ç™¼æ¨¡å¼æ”¯æ´ Mock è³‡æ–™

---

### 3. UI æ›´æ–°

**æª”æ¡ˆ**: `src/features/admin/ShopSettings.tsx`

**æ–° UI çµæ§‹**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ’¬ LINE è¨Šæ¯é…é¡                     â”‚
â”‚ æœ¬æœˆ LINE OA çš„è¨Šæ¯ä½¿ç”¨ç‹€æ³          â”‚
â”‚                                     â”‚
â”‚ â”Œâ”€â”€â”€ LINE å®˜æ–¹é…é¡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚                               â”‚  â”‚
â”‚ â”‚    12æœˆä»½é…é¡                 â”‚  â”‚
â”‚ â”‚    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  â”‚  â”‚
â”‚ â”‚                               â”‚  â”‚
â”‚ â”‚    500 å‰‡                     â”‚  â”‚
â”‚ â”‚    æ¯æœˆå…è²»é¡åº¦               â”‚  â”‚
â”‚ â”‚                               â”‚  â”‚
â”‚ â”‚    é€²åº¦æ¢ [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘] 49%  â”‚  â”‚
â”‚ â”‚    å·²ä½¿ç”¨ï¼š247 å‰‡             â”‚  â”‚
â”‚ â”‚    å‰©é¤˜ï¼š253 å‰‡               â”‚  â”‚
â”‚ â”‚                               â”‚  â”‚
â”‚ â”‚  âš ï¸ æ¥è¿‘é¡åº¦ä¸Šé™ï¼Œè«‹æ³¨æ„ä½¿ç”¨  â”‚  â”‚  <- è¶…é80%æ™‚é¡¯ç¤º
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                     â”‚
â”‚ â”Œâ”€â”€â”€ ç³»çµ±ç™¼é€çµ±è¨ˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚ ç³»çµ±çµ±è¨ˆç¸½è¨ˆï¼š247 å‰‡          â”‚  â”‚
â”‚ â”‚ â€¢ é ç´„é€šçŸ¥ï¼š123 å‰‡            â”‚  â”‚
â”‚ â”‚ â€¢ å®Œæˆé€šçŸ¥ï¼š89 å‰‡             â”‚  â”‚
â”‚ â”‚ â€¢ æé†’é€šçŸ¥ï¼š35 å‰‡             â”‚  â”‚
â”‚ â”‚ * è‡ªå‹•å›è¦†ä¸è¨ˆå…¥ LINE å®˜æ–¹é…é¡â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                     â”‚
â”‚               [ğŸ”„ é‡æ–°æ•´ç†]          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 4. æ¨£å¼è¨­è¨ˆ

**æª”æ¡ˆ**: `src/styles/pages/_shop-settings.scss`

**æ–°å¢ CSS é¡åˆ¥**:

- `.quota-official` - å®˜æ–¹é…é¡å€å¡Š
- `.quota-progress-bar` - é€²åº¦æ¢å®¹å™¨
  - `.progress-fill` - é€²åº¦æ¢å¡«å……
    - `.normal` - ç¶ è‰² (0-50%)
    - `.caution` - é»ƒè‰² (50-80%)
    - `.danger` - ç´…è‰² (80-100%)
- `.quota-warning` - è­¦å‘Šæç¤ºå€å¡Š
  - `.level-caution` - é»ƒè‰²è­¦å‘Š (80-90%)
  - `.level-danger` - ç´…è‰²è­¦å‘Š (90-100%)
  - `.level-critical` - åš´é‡è­¦å‘Š (100%)
- `.quota-stats` - ç³»çµ±çµ±è¨ˆå€å¡Š

**å‹•ç•«æ•ˆæœ**:

- `fadeIn` - è­¦å‘Šè¨Šæ¯æ·¡å…¥
- `pulse-warning` - è­¦å‘Šåœ–ç¤ºè„ˆå‹•

---

## è­¦å‘Šæ©Ÿåˆ¶

### è­¦å‘Šç­‰ç´š

| ä½¿ç”¨ç‡  | ç­‰ç´š | é¡è‰² | å‹•ä½œ                                       |
| ------- | ---- | ---- | ------------------------------------------ |
| 0-50%   | æ­£å¸¸ | ç¶ è‰² | ç„¡è­¦å‘Š                                     |
| 50-80%  | æ³¨æ„ | é»ƒè‰² | ç„¡è­¦å‘Š                                     |
| 80-90%  | è­¦æˆ’ | æ©˜é»ƒ | é¡¯ç¤ºè­¦å‘Šï¼šæ¥è¿‘é…é¡ä¸Šé™                     |
| 90-100% | å±éšª | ç´…è‰² | é¡¯ç¤ºè­¦å‘Šï¼šé…é¡å³å°‡ç”¨ç›¡ï¼ˆå«è„ˆå‹•å‹•ç•«ï¼‰       |
| 100%    | è‡¨ç•Œ | æ·±ç´… | é¡¯ç¤ºè­¦å‘Šï¼šå·²é”ä¸Šé™ï¼Œå»ºè­°å‡ç´šï¼ˆå«è„ˆå‹•å‹•ç•«ï¼‰ |

### è­¦å‘Šè¨Šæ¯

**80-90% (è­¦æˆ’)**:

```
âš ï¸ æ¥è¿‘é…é¡ä¸Šé™
å·²ä½¿ç”¨ X%ï¼Œè«‹æ³¨æ„ä½¿ç”¨ç‹€æ³
```

**90-100% (å±éšª)**:

```
âš ï¸ é…é¡å³å°‡ç”¨ç›¡
å·²ä½¿ç”¨ X%ï¼Œè«‹æ³¨æ„æ§åˆ¶ç™¼é€é‡
```

**100% (è‡¨ç•Œ)**:

```
âš ï¸ å·²é”æ¯æœˆè¨Šæ¯ä¸Šé™
è«‹å‡ç´š LINE OA æ–¹æ¡ˆä»¥ç¹¼çºŒç™¼é€è¨Šæ¯
```

---

## éŒ¯èª¤è™•ç†

### é™ç´šç­–ç•¥

1. **å®˜æ–¹é…é¡æŸ¥è©¢å¤±æ•—**

   - ä»é¡¯ç¤ºç³»çµ±çµ±è¨ˆè³‡æ–™
   - ä¸å½±éŸ¿æ ¸å¿ƒåŠŸèƒ½
   - Console è¨˜éŒ„è­¦å‘Šè¨Šæ¯

2. **æœªè¨­å®š Channel Access Token**

   - é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯ï¼šã€Œè«‹å…ˆåœ¨ Superadmin è¨­å®š LINE Channel Access Tokenã€
   - æä¾›è¨­å®šæç¤º

3. **LINE API éŒ¯èª¤**
   - é¡¯ç¤ºç³»çµ±çµ±è¨ˆä½œç‚ºå‚™ç”¨
   - éŒ¯èª¤è¨Šæ¯ï¼šã€Œç„¡æ³•é€£æ¥ LINE APIï¼Œé¡¯ç¤ºç³»çµ±çµ±è¨ˆã€

---

## æ¸¬è©¦æƒ…å¢ƒ

### é–‹ç™¼æ¨¡å¼æ¸¬è©¦

**Mock è³‡æ–™**:

- ç¸½é…é¡: 200 å‰‡ï¼ˆå°ç£è¼•ç”¨é‡æ–¹æ¡ˆï¼‰
- å·²ä½¿ç”¨: 123 å‰‡ (61.5%)
- å‰©é¤˜: 77 å‰‡

**æ¸¬è©¦é …ç›®**:

- âœ… Widget æ­£å¸¸é¡¯ç¤º
- âœ… é€²åº¦æ¢æ­£ç¢ºæ¸²æŸ“ï¼ˆç¶ è‰²ï¼‰
- âœ… æ•¸æ“šæ ¼å¼åŒ–æ­£ç¢º
- âœ… ç³»çµ±çµ±è¨ˆåŒæ™‚é¡¯ç¤º
- âœ… é‡æ–°æ•´ç†æŒ‰éˆ•æ­£å¸¸é‹ä½œ

### æ­£å¼ç’°å¢ƒæ¸¬è©¦æª¢æŸ¥æ¸…å–®

#### 1. åŠŸèƒ½æ¸¬è©¦

- [ ] å®˜æ–¹é…é¡æ­£ç¢ºè®€å–
- [ ] ç³»çµ±çµ±è¨ˆæ­£ç¢ºé¡¯ç¤º
- [ ] å…©è€…æ•¸æ“šå¯èƒ½æœ‰å·®ç•°ï¼ˆæ­£å¸¸ç¾è±¡ï¼‰
- [ ] é‡æ–°æ•´ç†åŠŸèƒ½æ­£å¸¸

#### 2. è­¦å‘Šæ¸¬è©¦

éœ€è¦æ¨¡æ“¬ä¸åŒä½¿ç”¨ç‡ï¼š

**50-80% (æ³¨æ„)**:

- [ ] é€²åº¦æ¢é¡¯ç¤ºé»ƒè‰²
- [ ] ç„¡è­¦å‘Šè¨Šæ¯

**80-90% (è­¦æˆ’)**:

- [ ] é€²åº¦æ¢é¡¯ç¤ºæ©˜é»ƒè‰²
- [ ] é¡¯ç¤ºè­¦æˆ’è­¦å‘Š
- [ ] è­¦å‘Šè¨Šæ¯æ­£ç¢º

**90-100% (å±éšª)**:

- [ ] é€²åº¦æ¢é¡¯ç¤ºç´…è‰²
- [ ] é¡¯ç¤ºå±éšªè­¦å‘Š
- [ ] è­¦å‘Šåœ–ç¤ºè„ˆå‹•å‹•ç•«
- [ ] è­¦å‘Šè¨Šæ¯æ­£ç¢º

**100% (è‡¨ç•Œ)**:

- [ ] é€²åº¦æ¢é¡¯ç¤ºæ·±ç´…è‰²
- [ ] é¡¯ç¤ºè‡¨ç•Œè­¦å‘Š
- [ ] è­¦å‘Šåœ–ç¤ºè„ˆå‹•å‹•ç•«
- [ ] æç¤ºå‡ç´šæ–¹æ¡ˆ

#### 3. éŒ¯èª¤è™•ç†æ¸¬è©¦

- [ ] ç„¡ Token æ™‚é¡¯ç¤ºæ­£ç¢ºéŒ¯èª¤è¨Šæ¯
- [ ] API å¤±æ•—æ™‚é™ç´šé¡¯ç¤ºç³»çµ±çµ±è¨ˆ
- [ ] Token ç„¡æ•ˆæ™‚é¡¯ç¤ºé‡æ–°è¨­å®šæç¤º

#### 4. UI/UX æ¸¬è©¦

- [ ] è¡Œå‹•è£ç½®é¡¯ç¤ºæ­£å¸¸
- [ ] å‹•ç•«æµæš¢
- [ ] é…è‰²ç¬¦åˆè¨­è¨ˆ
- [ ] å­—é«”å¤§å°é©ä¸­
- [ ] é‡æ–°æ•´ç†æŒ‰éˆ•å›é¥‹æ˜ç¢º

---

## é‡è¦æ³¨æ„äº‹é …

### é…é¡è¨ˆç®—å·®ç•°

âš ï¸ **LINE å®˜æ–¹é…é¡ vs ç³»çµ±çµ±è¨ˆå¯èƒ½ä¸åŒ**

**åŸå› **:

- LINE å®˜æ–¹é…é¡ï¼šåªè¨ˆç®— Push API è¨Šæ¯
- ç³»çµ±çµ±è¨ˆï¼šåŒ…å«æ‰€æœ‰é€éç³»çµ±ç™¼é€çš„è¨Šæ¯
- Reply API çš„è‡ªå‹•å›è¦†ä¸è¨ˆå…¥å®˜æ–¹é…é¡

**è™•ç†æ–¹å¼**:

- ä»¥ LINE å®˜æ–¹æ•¸æ“šç‚ºä¸»è¦åƒè€ƒ
- ç³»çµ±çµ±è¨ˆä½œç‚ºè¼”åŠ©è³‡è¨Š
- UI ä¸Šæ˜ç¢ºæ¨™è¨»ã€Œè‡ªå‹•å›è¦†ä¸è¨ˆå…¥ LINE å®˜æ–¹é…é¡ã€

### LINE API é…é¡èªªæ˜

**å°ç£åœ°å€æ–¹æ¡ˆ** ([å®˜æ–¹è³‡è¨Š](https://tw.linebiz.com/faq/oa-price/message-price-list/)):

- **è¼•ç”¨é‡æ–¹æ¡ˆ**ï¼ˆå…è²»ï¼‰ï¼š200 å‰‡/æœˆ
- **ä¸­ç”¨é‡æ–¹æ¡ˆ**ï¼ˆæœˆè²» 800 å…ƒï¼‰ï¼š3,000 å‰‡/æœˆï¼ˆä¸å¯åŠ è³¼ï¼‰
- **é«˜ç”¨é‡æ–¹æ¡ˆ**ï¼ˆæœˆè²» 1,200 å…ƒï¼‰ï¼š6,000 å‰‡/æœˆï¼ˆå¯åŠ è³¼ï¼Œæ¯å‰‡ 0.2 å…ƒèµ·ï¼‰

**å…¶ä»–åœ°å€**ï¼š

- éƒ¨åˆ†åœ°å€å…è²»æ–¹æ¡ˆç‚º 500 å‰‡/æœˆ

**é‡è¦**ï¼šReply è¨Šæ¯ä¸è¨ˆå…¥é…é¡ï¼Œè¶…éé™åˆ¶å¾Œç„¡æ³•ç™¼é€ Push è¨Šæ¯

**è¨ˆå…¥é…é¡çš„è¨Šæ¯**:

- âœ… é ç´„é€šçŸ¥ (Push API)
- âœ… å®Œæˆé€šçŸ¥ (Push API)
- âœ… è‡¨æ™‚å›å ± (Push API)
- âœ… å©‰æ‹’é€šçŸ¥ (Push API)

**ä¸è¨ˆå…¥é…é¡çš„è¨Šæ¯**:

- âŒ è‡ªå‹•å›è¦† (Reply API)
- âŒ èŠå¤©å®¤å›è¦† (Reply API)

---

## éƒ¨ç½²æ­¥é©Ÿ

### 1. éƒ¨ç½² Cloud Functions

```bash
cd functions
npm run build
firebase deploy --only functions:getLineOfficialQuota
```

### 2. éƒ¨ç½²å‰ç«¯

```bash
npm run build
firebase deploy --only hosting
```

### 3. é©—è­‰éƒ¨ç½²

- ç™»å…¥ç®¡ç†å¾Œå°
- é€²å…¥ã€Œåº—é‹ªè¨­å®šã€
- æª¢æŸ¥ã€ŒLINE è¨Šæ¯é…é¡ã€Widget
- ç¢ºèªå®˜æ–¹é…é¡æ­£ç¢ºé¡¯ç¤º
- æ¸¬è©¦é‡æ–°æ•´ç†åŠŸèƒ½

---

## ç¶­è­·å»ºè­°

### ç›£æ§é …ç›®

1. æ¯æ—¥æª¢æŸ¥é…é¡ä½¿ç”¨ç‹€æ³
2. ç•™æ„è­¦å‘Šé€šçŸ¥
3. è¦åŠƒé…é¡ä½¿ç”¨ç­–ç•¥

### å„ªåŒ–æ–¹å‘

1. é…é¡ä½¿ç”¨è¶¨å‹¢åœ–è¡¨
2. æ¯æœˆé…é¡ä½¿ç”¨æ­·å²è¨˜éŒ„
3. é…é¡è¶…é 90% æ™‚ Email é€šçŸ¥
4. å»ºè­°å‡ç´šæ–¹æ¡ˆçš„æ™‚æ©Ÿæç¤º

---

## ç›¸é—œæ–‡ä»¶

- [LINE Messaging API Reference](https://developers.line.biz/en/reference/messaging-api/)
- [LINE Official Account Plans](https://www.linebiz.com/jp-en/other/)
- ç³»çµ±æ–‡ä»¶: `Documents/LINE_MESSAGING_README.md`

---

## æ›´æ–°æ—¥èªŒ

### 2024-12-18

- âœ… æ–°å¢ Cloud Function `getLineOfficialQuota`
- âœ… æ“´å…… `useLineMessageQuota` Hook æ•´åˆå®˜æ–¹é…é¡
- âœ… æ›´æ–° ShopSettings Widget UI
- âœ… æ–°å¢é…é¡é€²åº¦æ¢å’Œè­¦å‘Šæ©Ÿåˆ¶
- âœ… æ–°å¢ SCSS æ¨£å¼
- âœ… å¯¦ä½œéŒ¯èª¤è™•ç†èˆ‡é™ç´šæ–¹æ¡ˆ
- âœ… ç·¨è­¯æ¸¬è©¦é€šé

---

## å·²çŸ¥å•é¡Œ

ç„¡

---

## æŠ€è¡“æ”¯æ´

å¦‚æœ‰å•é¡Œï¼Œè«‹æª¢æŸ¥ï¼š

1. Firestore ä¸­ shops/{shopId} çš„ lineChannelAccessToken æ˜¯å¦æ­£ç¢ºè¨­å®š
2. Cloud Function çš„ CORS è¨­å®šæ˜¯å¦åŒ…å«æ‚¨çš„åŸŸå
3. LINE Messaging API çš„ Channel Access Token æ˜¯å¦æœ‰æ•ˆ
4. ç€è¦½å™¨ Console çš„éŒ¯èª¤è¨Šæ¯
