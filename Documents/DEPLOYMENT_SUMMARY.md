# è¨‚é–±åˆ¶åŠŸèƒ½éƒ¨ç½²ç¸½çµ

## ğŸ“… éƒ¨ç½²æ™‚é–“

**2024-12-17**

## âœ… éƒ¨ç½²ç‹€æ…‹ï¼šå®Œæˆ

æ‰€æœ‰è¨‚é–±åˆ¶åŠŸèƒ½å·²æˆåŠŸéƒ¨ç½²åˆ° Firebase å°ˆæ¡ˆ `pet-crm-bb6e9`ã€‚

---

## ğŸš€ å·²éƒ¨ç½²é …ç›®

### 1. Firestore å®‰å…¨è¦å‰‡ âœ…

- **ç‹€æ…‹**: å·²éƒ¨ç½²
- **æ›´æ–°å…§å®¹**:
  - å…è¨± SuperAdmin ç®¡ç†æ‰€æœ‰åº—é‹ªçš„è¨‚é–±è³‡è¨Š
  - ä¿æŒåŸæœ‰æ¬Šé™çµæ§‹ä¸è®Š

### 2. Cloud Functions âœ…

- **ç‹€æ…‹**: å·²éƒ¨ç½²
- **éƒ¨ç½²å€åŸŸ**: us-central1

#### a) checkExpiredSubscriptions (å®šæ™‚ä»»å‹™)

- **é¡å‹**: æ’ç¨‹å‡½æ•¸
- **åŸ·è¡Œæ™‚é–“**: æ¯å¤© 00:00ï¼ˆå°åŒ—æ™‚é–“ï¼‰
- **åŠŸèƒ½**: è‡ªå‹•æª¢æŸ¥ä¸¦æ¨™è¨˜éæœŸè¨‚é–±
- **è¨˜æ†¶é«”**: 256MB

#### b) manualCheckExpiredSubscriptions (æ‰‹å‹•è§¸ç™¼)

- **é¡å‹**: HTTP å‡½æ•¸
- **URL**: `https://us-central1-pet-crm-bb6e9.cloudfunctions.net/manualCheckExpiredSubscriptions`
- **åŠŸèƒ½**: æ‰‹å‹•è§¸ç™¼æª¢æŸ¥éæœŸè¨‚é–±ï¼ˆç”¨æ–¼æ¸¬è©¦ï¼‰
- **éœ€è¦**: Bearer Token æˆæ¬Š

### 3. Frontend (Hosting) âœ…

- **ç‹€æ…‹**: å·²éƒ¨ç½²
- **URL**: https://pet-crm-bb6e9.web.app
- **åŒ…å«åŠŸèƒ½**:
  - SuperAdmin è¨‚é–±ç®¡ç†ä»‹é¢
  - Admin Dashboard è¨‚é–±ç‹€æ…‹é¡¯ç¤º
  - ç™»å…¥è¨‚é–±æª¢æŸ¥
  - è¯ç¹«å®¢æœå½ˆçª—
  - å®Œæ•´çš„ SCSS æ¨£å¼

---

## ğŸ“Š åŠŸèƒ½é©—è­‰æ¸…å–®

è«‹æŒ‰ç…§ä»¥ä¸‹æ¸…å–®é©—è­‰æ‰€æœ‰åŠŸèƒ½ï¼š

### SuperAdmin åŠŸèƒ½

- [ ] ç™»å…¥ SuperAdmin å¸³è™Ÿ
- [ ] é€²å…¥åº—é‹ªç®¡ç†é é¢
- [ ] æ¸¬è©¦æ–°å¢è¨‚é–±ï¼ˆè©¦ç”¨æœŸ/æœˆè¨‚é–±/å¹´è¨‚é–±ï¼‰
- [ ] æ¸¬è©¦çºŒè¨‚åŠŸèƒ½
- [ ] æ¸¬è©¦ä¿®æ”¹æ–¹æ¡ˆåŠŸèƒ½
- [ ] æ¸¬è©¦åœç”¨è¨‚é–±åŠŸèƒ½
- [ ] é©—è­‰å³å°‡åˆ°æœŸç¯©é¸ï¼ˆé¡¯ç¤º 7 å¤©å…§åˆ°æœŸçš„åº—å®¶ï¼‰
- [ ] ç¢ºèªè¨‚é–±æ–¹æ¡ˆå’Œç‹€æ…‹å¾½ç« é¡¯ç¤ºæ­£ç¢º
- [ ] ç¢ºèªå‰©é¤˜å¤©æ•¸è¨ˆç®—æ­£ç¢º

### Admin åŠŸèƒ½

- [ ] ä½¿ç”¨æœ‰è¨‚é–±çš„åº—å®¶ç®¡ç†å“¡å¸³è™Ÿç™»å…¥
- [ ] é€²å…¥ã€Œåº—é‹ªè¨­å®šã€é é¢
- [ ] ç¢ºèªè¨‚é–±ç‹€æ…‹ Widget é¡¯ç¤ºæ­£ç¢º
- [ ] ç¢ºèªé¡¯ç¤ºè¨‚é–±æ–¹æ¡ˆã€ç‹€æ…‹ã€åˆ°æœŸæ—¥ã€å‰©é¤˜å¤©æ•¸
- [ ] ç¢ºèªå‰©é¤˜å¤©æ•¸ â‰¤ 7 å¤©æ™‚é¡¯ç¤ºè­¦å‘Šæ¨£å¼

### ç™»å…¥æª¢æŸ¥åŠŸèƒ½

- [ ] å‰µå»ºä¸€å€‹æ¸¬è©¦åº—å®¶ï¼Œè¨­å®šè¨‚é–±ç‚ºã€Œå·²åœç”¨ã€
- [ ] å˜—è©¦ä½¿ç”¨è©²åº—å®¶çš„ç®¡ç†å“¡å¸³è™Ÿç™»å…¥
- [ ] ç¢ºèªç„¡æ³•ç™»å…¥ä¸¦é¡¯ç¤ºè¯ç¹«å®¢æœå½ˆçª—
- [ ] ç¢ºèªå½ˆçª—é¡¯ç¤ºå®¢æœé›»è©±ã€ä¿¡ç®±ã€LINE è³‡è¨Š
- [ ] ç¢ºèª SuperAdmin å¯ä»¥æ­£å¸¸ç™»å…¥ï¼ˆä¸å—è¨‚é–±é™åˆ¶ï¼‰

### Cloud Function åŠŸèƒ½

- [ ] æ¸¬è©¦æ‰‹å‹•è§¸ç™¼éæœŸæª¢æŸ¥ï¼š
  ```bash
  curl -X POST \
    https://us-central1-pet-crm-bb6e9.cloudfunctions.net/manualCheckExpiredSubscriptions \
    -H "Authorization: Bearer YOUR_TOKEN" \
    -H "Content-Type: application/json"
  ```
- [ ] æª¢æŸ¥ Firebase Console ä¸­çš„ Function æ—¥èªŒ
- [ ] å‰µå»ºä¸€å€‹éæœŸè¨‚é–±æ¸¬è©¦ï¼ˆä¿®æ”¹ Firestore ä¸­çš„åˆ°æœŸæ—¥ç‚ºéå»æ—¥æœŸï¼‰
- [ ] åŸ·è¡Œæ‰‹å‹•è§¸ç™¼ï¼Œç¢ºèªè¨‚é–±ç‹€æ…‹è¢«æ›´æ–°ç‚º `expired`
- [ ] ç¢ºèªå®šæ™‚ä»»å‹™å·²è¨­å®šï¼ˆFirebase Console > Functions > Schedulerï¼‰

---

## ğŸ” å·²çŸ¥å•é¡Œèˆ‡æ³¨æ„äº‹é …

### 1. SCSS Deprecation Warnings

- **ç‹€æ…‹**: è­¦å‘Šï¼ˆééŒ¯èª¤ï¼‰
- **èªªæ˜**: Sass ä¸­çš„ `darken()` å‡½æ•¸å·²éæ™‚
- **å½±éŸ¿**: ä¸å½±éŸ¿åŠŸèƒ½ï¼Œä½†å»ºè­°æœªä¾†é·ç§»åˆ° `color.adjust()`
- **å„ªå…ˆç´š**: ä½

### 2. Firebase Functions SDK ç‰ˆæœ¬

- **è­¦å‘Šè¨Šæ¯**: "outdated version of firebase-functions"
- **ç•¶å‰ç‰ˆæœ¬**: 4.9.0
- **å»ºè­°ç‰ˆæœ¬**: æœ€æ–°ç‰ˆæœ¬
- **å½±éŸ¿**: ä¸å½±éŸ¿ç¾æœ‰åŠŸèƒ½ï¼Œä½†å»ºè­°æœªä¾†å‡ç´š
- **å„ªå…ˆç´š**: ä¸­

### 3. Node.js ç‰ˆæœ¬è­¦å‘Š

- **è­¦å‘Šè¨Šæ¯**: "Unsupported engine"
- **éœ€æ±‚ç‰ˆæœ¬**: Node 20
- **ç•¶å‰ç‰ˆæœ¬**: Node 24.7.0
- **å½±éŸ¿**: ä¸å½±éŸ¿åŠŸèƒ½ï¼ˆå‘ä¸Šå…¼å®¹ï¼‰
- **å„ªå…ˆç´š**: ä½

### 4. NPM å®‰å…¨æ¼æ´

- **4 critical severity vulnerabilities**
- **å»ºè­°**: åœ¨æ¸¬è©¦å¾ŒåŸ·è¡Œ `npm audit fix`
- **å„ªå…ˆç´š**: ä¸­

---

## ğŸ“ éƒ¨ç½²å¾Œè¨­å®š

### 1. æ›´æ–°å®¢æœè¯ç¹«è³‡è¨Š

è«‹åœ¨ `src/features/admin/AdminLogin.tsx` ä¸­æ›´æ–°å¯¦éš›çš„å®¢æœè¯ç¹«æ–¹å¼ï¼š

```typescript
// ç›®å‰çš„ç¯„ä¾‹è³‡æ–™
ğŸ“ å®¢æœé›»è©±ï¼š0800-123-456
âœ‰ï¸ å®¢æœä¿¡ç®±ï¼šsupport@petcrm.com
ğŸ’¬ LINE å®˜æ–¹å¸³è™Ÿï¼š@petcrm

// è«‹æ›¿æ›ç‚ºå¯¦éš›çš„è¯ç¹«æ–¹å¼
```

### 2. ç‚ºç¾æœ‰åº—å®¶è¨­å®šè¨‚é–±

ç¾æœ‰çš„åº—å®¶è³‡æ–™ä¸åŒ…å« `subscription` æ¬„ä½ï¼Œéœ€è¦æ‰‹å‹•è¨­å®šï¼š

1. ç™»å…¥ SuperAdmin
2. ç‚ºæ¯å€‹åº—å®¶é»æ“Š ğŸ’³ åœ–ç¤º
3. é¸æ“‡é©ç•¶çš„è¨‚é–±æ–¹æ¡ˆä¸¦å„²å­˜

### 3. é©—è­‰å®šæ™‚ä»»å‹™

æª¢æŸ¥ Cloud Scheduler æ˜¯å¦å·²æ­£ç¢ºè¨­å®šï¼š

1. å‰å¾€ [Firebase Console](https://console.firebase.google.com/project/pet-crm-bb6e9/functions)
2. æŸ¥çœ‹ Functions åˆ—è¡¨
3. ç¢ºèª `checkExpiredSubscriptions` æœ‰æ’ç¨‹è¨­å®š
4. ç¢ºèªæ’ç¨‹æ™‚é–“ç‚ºæ¯å¤© 00:00ï¼ˆAsia/Taipeiï¼‰

---

## ğŸ¯ æ¸¬è©¦å»ºè­°

### æ¸¬è©¦æƒ…å¢ƒ 1: æ–°è¨‚é–±æµç¨‹

1. SuperAdmin ç‚ºæ¸¬è©¦åº—å®¶æ–°å¢è©¦ç”¨æœŸè¨‚é–±
2. Admin ç™»å…¥æŸ¥çœ‹è¨‚é–±ç‹€æ…‹
3. ç¢ºèªé¡¯ç¤ºã€ŒğŸ è©¦ç”¨æœŸã€ã€ã€Œâœ“ å•Ÿç”¨ä¸­ã€ã€åˆ°æœŸæ—¥ç‚º 3 å€‹æœˆå¾Œ

### æ¸¬è©¦æƒ…å¢ƒ 2: çºŒè¨‚æµç¨‹

1. SuperAdmin é»æ“Šã€ŒçºŒè¨‚ã€æŒ‰éˆ•
2. ç¢ºèªåˆ°æœŸæ—¥å»¶é•·ç›¸åŒæœŸé™
3. Admin æŸ¥çœ‹ç¢ºèªå‰©é¤˜å¤©æ•¸å¢åŠ 

### æ¸¬è©¦æƒ…å¢ƒ 3: ä¿®æ”¹æ–¹æ¡ˆ

1. SuperAdmin å°‡è©¦ç”¨æœŸæ”¹ç‚ºæœˆè¨‚é–±
2. ç¢ºèªæ–¹æ¡ˆå¾½ç« è®Šæ›´
3. ç¢ºèªåˆ°æœŸæ—¥é‡æ–°è¨ˆç®—

### æ¸¬è©¦æƒ…å¢ƒ 4: åœç”¨æµç¨‹

1. SuperAdmin åœç”¨æ¸¬è©¦åº—å®¶çš„è¨‚é–±
2. ä½¿ç”¨è©²åº—å®¶ Admin å¸³è™Ÿç™»å…¥
3. ç¢ºèªç„¡æ³•ç™»å…¥ä¸¦é¡¯ç¤ºè¯ç¹«å®¢æœå½ˆçª—

### æ¸¬è©¦æƒ…å¢ƒ 5: éæœŸè‡ªå‹•è™•ç†

1. åœ¨ Firestore ä¸­æ‰‹å‹•è¨­å®šæ¸¬è©¦åº—å®¶çš„åˆ°æœŸæ—¥ç‚ºæ˜¨å¤©
2. æ‰‹å‹•è§¸ç™¼éæœŸæª¢æŸ¥ Function
3. ç¢ºèªè¨‚é–±ç‹€æ…‹è‡ªå‹•æ›´æ–°ç‚º `expired`
4. ç¢ºèªè©²åº—å®¶ç„¡æ³•ç™»å…¥

### æ¸¬è©¦æƒ…å¢ƒ 6: å³å°‡åˆ°æœŸæé†’

1. SuperAdmin è¨­å®šæ¸¬è©¦åº—å®¶çš„åˆ°æœŸæ—¥ç‚º 5 å¤©å¾Œ
2. é»æ“Šã€Œå³å°‡åˆ°æœŸã€ç¯©é¸æŒ‰éˆ•
3. ç¢ºèªè©²åº—å®¶å‡ºç¾åœ¨åˆ—è¡¨ä¸­
4. Admin ç™»å…¥ç¢ºèªå‰©é¤˜å¤©æ•¸ä»¥è­¦å‘Šè‰²é¡¯ç¤º

---

## ğŸ“š ç›¸é—œæ–‡ä»¶

- **åŠŸèƒ½èªªæ˜**: `SUBSCRIPTION_FEATURE.md`
- **API æ–‡ä»¶**: Firebase Functions æ—¥èªŒ
- **åŸå§‹ç¢¼**:
  - Types: `src/types/shop.ts`
  - SuperAdmin: `src/features/superadmin/ShopManager.tsx`
  - Admin: `src/features/admin/ShopSettings.tsx`
  - Login: `src/features/admin/AdminLogin.tsx`
  - Functions: `functions/src/index.ts`

---

## ğŸ”— é‡è¦é€£çµ

- **Firebase Console**: https://console.firebase.google.com/project/pet-crm-bb6e9/overview
- **å‰ç«¯ç¶²ç«™**: https://pet-crm-bb6e9.web.app
- **æ‰‹å‹•è§¸ç™¼ API**: https://us-central1-pet-crm-bb6e9.cloudfunctions.net/manualCheckExpiredSubscriptions
- **Firestore æ•¸æ“šåº«**: https://console.firebase.google.com/project/pet-crm-bb6e9/firestore
- **Functions æ—¥èªŒ**: https://console.firebase.google.com/project/pet-crm-bb6e9/functions/logs

---

## ğŸ‰ éƒ¨ç½²æˆåŠŸ

æ‰€æœ‰è¨‚é–±åˆ¶åŠŸèƒ½å·²æˆåŠŸéƒ¨ç½²ä¸¦å¯ä»¥é–‹å§‹ä½¿ç”¨ï¼

å¦‚æœ‰ä»»ä½•å•é¡Œï¼Œè«‹åƒè€ƒï¼š

1. `SUBSCRIPTION_FEATURE.md` - åŠŸèƒ½è©³ç´°èªªæ˜
2. Firebase Console Logs - é‹è¡Œæ—¥èªŒ
3. æœ¬æ–‡ä»¶çš„æ¸¬è©¦æ¸…å–® - é©—è­‰æ­¥é©Ÿ

**éƒ¨ç½²å®Œæˆæ™‚é–“**: 2024-12-17
**éƒ¨ç½²äººå“¡**: AI Assistant
**å°ˆæ¡ˆç‹€æ…‹**: âœ… ç”Ÿç”¢å°±ç·’
