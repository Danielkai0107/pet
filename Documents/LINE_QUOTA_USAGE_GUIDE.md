# LINE 訊息配額使用指南

## 📊 目前部署的 Cloud Functions

### 💰 會計入配額的函數（Push API）

#### 1. `onAppointmentStatusConfirmed` ⭐⭐⭐⭐⭐

**用途**：預約狀態變化通知（確認/取消）

**觸發時機**：

- 待確認 → 已確認：發送「預約已確認」通知
- 已確認 → 已取消：發送「預約已取消」通知

**配額消耗**：💰 每次 **1 則**

**必要性**：⭐⭐⭐⭐⭐ 必要（客戶需要知道預約狀態）

---

#### 2. `sendServiceCompletionNotification` ⭐⭐⭐⭐

**用途**：服務完成通知 + 標記預約為已完成

**觸發時機**：管理員在預約詳情點擊「LINE 通知主人完成」按鈕

**配額消耗**：💰 每次 **1 則**

**必要性**：⭐⭐⭐⭐ 建議（通知客戶接回寵物）

**注意**：

- 會同時更新預約狀態為「已完成」
- 不可逆操作

---

#### 3. `sendLineCompletionMessage` ⭐⭐⭐⭐

**用途**：發送完成照片 + 自訂訊息

**觸發時機**：管理員手動上傳照片並發送

**配額消耗**：💰 每次 **1 則**

**必要性**：⭐⭐⭐⭐ 建議（提升客戶滿意度，可選）

**建議**：

- 精選重點客戶發送
- 結合完成通知使用（不要分開發）

---

#### 4. `sendLineTempReportMessage` ⭐⭐⭐

**用途**：服務進行中的即時回報

**觸發時機**：管理員手動發送

**配額消耗**：💰 每次 **1 則**

**必要性**：⭐⭐⭐ 額外服務（VIP 客戶或特殊情況）

**建議**：

- 保留給 VIP 客戶
- 特殊服務（如手術、複雜美容）才發送

---

#### 5. `declineAppointment` ⭐⭐⭐⭐⭐

**用途**：預約婉拒通知

**觸發時機**：管理員點擊「婉拒」按鈕

**配額消耗**：💰 每次 **1 則**

**必要性**：⭐⭐⭐⭐⭐ 必要（客戶需要知道並改預約）

---

### 🆓 不計入配額的函數（免費）

#### 6. `lineWebhook` 🆓

**用途**：自動回覆關鍵字

**觸發時機**：客戶在 LINE 發送訊息匹配關鍵字

**API 類型**：Reply API

**配額消耗**：🆓 **0 則（完全免費，無限制）**

**建議**：

- 設定常見問題自動回覆
- 營業時間、地址、價格等
- 可以大量使用，不用擔心

---

#### 7. 客戶端 `liff.sendMessages()` 🆓

**用途**：客戶操作後的確認訊息

**觸發時機**：

- 客戶提交預約
- 客戶取消預約

**配額消耗**：🆓 **0 則（完全免費）**

**優勢**：

- 即時反饋
- 不消耗配額
- 改善用戶體驗

---

### 🔧 工具函數（不發送訊息）

#### 8. `getLineOfficialQuota`

**用途**：查詢 LINE 官方配額

**配額消耗**：🆓 **0 則**（只查詢，不發送訊息）

---

#### 9. `getLineMessageQuota`

**用途**：查詢系統內部統計

**配額消耗**：🆓 **0 則**（只查詢，不發送訊息）

---

#### 10. `checkExpiredSubscriptions`

**用途**：定時檢查訂閱過期（每天 00:00 執行）

**配額消耗**：🆓 **0 則**（不發送訊息）

---

#### 11. `manualCheckExpiredSubscriptions`

**用途**：手動觸發檢查訂閱過期

**配額消耗**：🆓 **0 則**（不發送訊息）

---

## 📈 典型使用場景配額消耗

### 場景 A：標準流程（推薦）

```
客戶提交預約
  ↓
🆓 liff.sendMessages() - 聊天室確認
  ↓
管理員確認預約
  ↓
💰 1則 - 預約確認通知（Push API）
  ↓
服務完成
  ↓
💰 1則 - 服務完成通知（Push API）
```

**總消耗**：💰 **2 則/預約**

**200 則可支援**：**100 個預約/月**

---

### 場景 B：精簡流程（省配額）

```
客戶提交預約
  ↓
🆓 liff.sendMessages() - 聊天室確認
  ↓
管理員確認預約
  ↓
💰 1則 - 預約確認通知（Push API）
  ↓
服務完成
  ↓
口頭或電話通知（不發 LINE 訊息）
```

**總消耗**：💰 **1 則/預約**

**200 則可支援**：**200 個預約/月**

---

### 場景 C：豪華服務（需更多配額）

```
客戶提交預約
  ↓
🆓 liff.sendMessages() - 聊天室確認
  ↓
管理員確認預約
  ↓
💰 1則 - 預約確認通知
  ↓
服務進行中
  ↓
💰 1則 - 臨時回報（照片 + 訊息）
  ↓
服務完成
  ↓
💰 1則 - 完成照分享（照片 + 訊息）
```

**總消耗**：💰 **3 則/預約**

**200 則可支援**：**66 個預約/月**（建議升級到中用量）

---

## 💡 配額管理策略

### 輕用量方案（200 則/月）

#### 適合的店家

- 每月預約數：50-100 個
- 服務類型：標準服務
- 客戶類型：一般客戶

#### 推薦設定

1. ✅ **必發**：預約確認通知（1 則/預約）
2. 📝 **選發**：服務完成通知（只給要求的客戶）
3. ❌ **不發**：臨時回報（改用電話或當面告知）

#### 配額分配

- 預約確認：150 則
- 服務完成：30 則（20% 的客戶）
- 預約婉拒：10 則（緩衝）
- 臨時回報：10 則（緊急情況）
- **總計：200 則** ✅

---

### 中用量方案（3,000 則/月）

#### 適合的店家

- 每月預約數：100-500 個
- 服務類型：多樣化服務
- 客戶類型：重視服務體驗

#### 推薦設定

1. ✅ **必發**：預約確認通知
2. ✅ **必發**：服務完成通知
3. 📝 **選發**：完成照分享（50% 客戶）
4. 📝 **選發**：臨時回報（VIP 客戶）

#### 配額分配

- 預約確認：500 則
- 服務完成：500 則
- 完成照分享：250 則
- 臨時回報：100 則
- 其他緩衝：1,650 則
- **總計：3,000 則** ✅

---

## 🎯 最佳實踐

### 1. 配額監控

- ✅ 每日查看 LINE 管理頁面
- ✅ 關注配額使用率
- ✅ 80% 時開始控制發送

### 2. 訊息優先級

- **必發**（不可省略）：
  - 預約確認/婉拒通知
- **建議發送**（提升體驗）：

  - 服務完成通知
  - 完成照分享

- **可選發送**（額外服務）：
  - 臨時回報
  - 即時更新

### 3. 免費功能多用

- ✅ 設定豐富的自動回覆（免費）
- ✅ 客戶端用 sendMessages（免費）
- ✅ 減少 Push API 使用

### 4. 合併訊息

- ❌ 不要：分開發「完成通知」+ 「完成照」= 2 則
- ✅ 推薦：合併發「完成照分享」（含照片和訊息）= 1 則

### 5. 選擇性發送

- 不是每個預約都需要發完成通知
- 依客戶需求和服務類型決定
- VIP 客戶優先

---

## 🚫 已移除的功能

### ❌ `onAppointmentCreated`

- **原因**：浪費配額，改用免費的 `liff.sendMessages()`
- **節省**：每預約 1 則
- **影響**：無，客戶體驗不受影響

### ❌ `sendTestMessages`

- **原因**：測試會浪費 3 則配額
- **節省**：每次測試 3 則
- **替代方案**：
  - 在開發環境測試
  - 或者直接用真實預約測試功能
  - LINE Developers Console 也提供測試工具

---

## 📊 配額使用計算器

### 估算您的月配額需求

填入您的預估數據：

```
每月預約數：_____ 個
必發訊息（確認）：_____ × 1 = _____ 則
選發訊息（完成）：_____ × 1 = _____ 則  (例如：50% 預約)
選發訊息（臨時）：_____ × 1 = _____ 則  (例如：10% 預約)
婉拒預約：_____ × 1 = _____ 則  (例如：5% 預約)
────────────────────────────────
總計需求：_____ 則/月

對應方案：
□ 200 則（輕用量，免費）
□ 3,000 則（中用量，800 元/月）
□ 6,000 則（高用量，1,200 元/月）
```

### 範例計算

**小型店家**（每月 80 個預約）：

- 確認通知：80 × 1 = 80 則
- 完成通知：40 × 1 = 40 則（50%）
- 婉拒通知：5 × 1 = 5 則
- **總計：125 則** → ✅ **輕用量方案（200 則）即可**

**中型店家**（每月 150 個預約）：

- 確認通知：150 × 1 = 150 則
- 完成通知：150 × 1 = 150 則（100%）
- 臨時回報：30 × 1 = 30 則（20%）
- 婉拒通知：10 × 1 = 10 則
- **總計：340 則** → ⚠️ **需升級到中用量方案（3,000 則）**

---

## ⚠️ 注意事項

### 配額達上限後

當配額用盡時：

- ❌ 無法發送 Push API 訊息
- ✅ 自動回覆仍可正常運作
- ✅ 客戶端 sendMessages 仍可使用
- ✅ 需等到下個月或升級方案

### 中用量方案限制

⚠️ **重要**：中用量方案（800 元/月，3,000 則）**不可加購訊息**

- 用完 3,000 則後無法繼續發送
- 必須升級到高用量方案（1,200 元/月）才能加購
- 選擇時要考慮成長空間

---

## 📱 客戶體驗不受影響

### 客戶仍會收到的訊息

✅ **預約提交時**：

- 聊天室立即顯示「預約送出成功」（免費）

✅ **管理員確認後**：

- LINE 推播「預約已確認」通知（付費）

✅ **服務完成時**：

- LINE 推播「服務完成」通知（付費，可選）
- 或口頭/電話通知（免費）

✅ **關鍵字詢問時**：

- 自動回覆常見問題（免費）

---

## 🎯 部署狀態

### 已部署的 Cloud Functions

✅ **配額管理**：

- `getLineOfficialQuota` - 查詢官方配額
- `getLineMessageQuota` - 查詢系統統計

✅ **訊息發送**：

- `onAppointmentStatusConfirmed` - 預約狀態變化通知
- `sendServiceCompletionNotification` - 完成通知
- `sendLineCompletionMessage` - 完成照分享
- `sendLineTempReportMessage` - 臨時回報
- `declineAppointment` - 婉拒通知
- `lineWebhook` - 自動回覆（免費）

✅ **系統維護**：

- `checkExpiredSubscriptions` - 定時檢查訂閱
- `manualCheckExpiredSubscriptions` - 手動檢查訂閱

❌ **已移除**：

- `onAppointmentCreated` - 預約建立通知（改用免費方案）
- `sendTestMessages` - 測試訊息（避免浪費配額）

---

## 📖 相關文件

- [LINE 訊息配額監控系統](./LINE_QUOTA_MONITORING.md)
- [LINE 台灣地區配額說明](./LINE_QUOTA_TAIWAN.md)
- [LINE 訊息優化策略](./LINE_MESSAGE_OPTIMIZATION.md)
- [LINE 自動回覆部署指南](./LINE_AUTO_REPLY_DEPLOYMENT.md)

---

## 更新日誌

### 2024-12-18

#### 配額優化

- ❌ 停用 `onAppointmentCreated`（節省每預約 1 則）
- ❌ 移除 `sendTestMessages`（避免測試浪費 3 則）
- ✅ 保留所有重要的 Push 通知
- ✅ 保留所有免費功能（Reply API, sendMessages）

#### 估算效益

- 每預約節省 1 則配額
- 200 則可支援 100-200 個預約
- 配額使用效率提升 50-100%

---

## 常見問題

### Q: 移除預約建立通知後，客戶還會收到確認嗎？

**A**: 會！客戶會在兩個地方看到確認：

1. 提交預約時：LIFF 聊天室立即顯示「預約送出成功」（免費）
2. 管理員確認後：LINE 推播「預約已確認」通知（付費）

### Q: 為什麼要移除測試功能？

**A**: `sendTestMessages` 每次測試會消耗 **3 則配額**（發送 3 種測試訊息）。在 200 則配額的限制下，測試 10 次就用掉 30 則（15%），非常不划算。

**替代方案**：

- 用真實預約測試功能
- 在開發環境測試
- 使用 LINE Developers Console 的測試工具

### Q: 如果我想測試 LINE API 連接怎麼辦？

**A**:

1. 在 Superadmin 設定 Channel Access Token 後
2. 創建一個真實預約並確認它
3. 觀察客戶是否收到通知
4. 只會消耗 1 則配額，比測試功能節省 2 則

### Q: 我應該每個預約都發完成通知嗎？

**A**: 取決於您的配額和需求：

- **配額充足**（中/高用量）：建議都發送
- **配額緊張**（輕用量 200 則）：選擇性發送：
  - 只給有要求的客戶
  - 只發完成照分享（結合照片和通知）
  - VIP 客戶優先

---

## 🎉 系統已優化完成

您的 CRM 現在：

- ✅ 最大化利用免費功能
- ✅ 精簡付費訊息使用
- ✅ 提供即時配額監控
- ✅ 智能警告機制
- ✅ 完全不影響客戶體驗

**200 則配額現在可以支援更多預約了！** 🚀
